#!/bin/bash

# Multivac - Create and start a tutorial project
# Usage: multivac [topic] [--dir <path>] [--new] [--launch]

MULTIVAC_VERSION="0.1.0"

set -e

# Default tutorial home directory (can be changed during install or via env var)
MULTIVAC_HOME="${MULTIVAC_HOME:-$HOME/multivac}"

# Working directory for this invocation (starts as home, can be overridden by --dir)
MULTIVAC_DIR="$MULTIVAC_HOME"

# ------------------------------------------------------------------------------
# Helper functions
# ------------------------------------------------------------------------------

# Check if we're running inside Claude Code by walking up the process tree
is_inside_claude() {
    local pid=$$
    while [ "$pid" != "1" ]; do
        local cmd=$(ps -o comm= -p "$pid" 2>/dev/null)
        [[ "$cmd" == *claude* ]] && return 0
        pid=$(ps -o ppid= -p "$pid" 2>/dev/null | tr -d ' ')
        [ -z "$pid" ] && break
    done
    return 1
}

# Launch Claude Code or print instructions
# Usage: launch_or_instruct <dir> <action>  (action: "start" or "continue")
launch_or_instruct() {
    local dir="$1"
    local action="$2"
    if $LAUNCH_MODE; then
        if is_inside_claude; then
            echo ""
            echo "Error: Cannot use --launch from within Claude Code"
            echo ""
            echo "To $action this tutorial, run: /tutorial"
            echo ""
            exit 1
        fi
        echo "Launching Claude Code..."
        echo ""
        cd "$dir" && exec claude
    else
        echo ""
        echo "To $action this tutorial:"
        echo "  cd $dir && claude"
        echo ""
        echo "You'll be prompted to $action automatically."
        echo ""
        exit 0
    fi
}

# Check if directory is a multivac project
is_multivac_project() {
    [[ -f "$1/CLAUDE.md" ]] && grep -q "<!-- multivac-tutorial -->" "$1/CLAUDE.md" 2>/dev/null
}

# Get topic name from CLAUDE.md
get_topic_name() {
    local dir="$1"
    if [[ -f "$dir/CLAUDE.md" ]]; then
        # Try <!-- topic: X -->
        local topic=$(sed -n 's/.*<!-- topic: \(.*\) -->.*/\1/p' "$dir/CLAUDE.md" 2>/dev/null | head -1)
        if [[ -z "$topic" ]]; then
            # Try **Topic:** X
            topic=$(sed -n 's/.*\*\*Topic:\*\* \(.*\)/\1/p' "$dir/CLAUDE.md" 2>/dev/null | head -1)
        fi
        echo "$topic"
    fi
}

# Get project version from CLAUDE.md
get_project_version() {
    local dir="$1"
    if [[ -f "$dir/CLAUDE.md" ]]; then
        sed -n 's/.*<!-- multivac-version: \(.*\) -->.*/\1/p' "$dir/CLAUDE.md" 2>/dev/null | head -1
    fi
}

# Write project config files (.mcp.json, .claude/settings.json, CLAUDE.md)
write_project_config() {
    local project_dir="$1"
    local topic_display="$2"

    # Get paths to installed components
    local mcp_server_path="$HOME/.claude/mcp-servers/learning-tracker/dist/index.js"
    local capstone_hook_path="$HOME/.claude/hooks/capstone-test-runner.sh"
    local tutorial_prompt_hook_path="$HOME/.claude/hooks/tutorial-prompt.sh"
    local compact_hook_path="$HOME/.claude/hooks/compact-hook.sh"
    local data_dir="$project_dir/.multivac"

    # Verify MCP server is installed
    if [[ ! -f "$mcp_server_path" ]]; then
        echo "Error: MCP server not found at $mcp_server_path"
        echo "Please run the Multivac installer first."
        exit 1
    fi

    mkdir -p "$project_dir/.claude"

    # MCP server config — tells Claude Code where to find the learning-tracker server
    cat > "$project_dir/.mcp.json" << EOF
{
  "mcpServers": {
    "learning-tracker": {
      "command": "node",
      "args": ["$mcp_server_path"],
      "env": {
        "MULTIVAC_DATA_DIR": "$data_dir"
      }
    }
  }
}
EOF

    # Hook config — SessionStart hooks for auto-prompt and compaction recovery,
    # PreToolUse hook for capstone test runner
    cat > "$project_dir/.claude/settings.json" << EOF
{
  "hooks": {
    "SessionStart": [
      {
        "matcher": "startup",
        "hooks": [{"type": "command", "command": "$tutorial_prompt_hook_path"}]
      },
      {
        "matcher": "resume",
        "hooks": [{"type": "command", "command": "$tutorial_prompt_hook_path"}]
      },
      {
        "matcher": "clear",
        "hooks": [{"type": "command", "command": "$tutorial_prompt_hook_path"}]
      },
      {
        "matcher": "compact",
        "hooks": [{"type": "command", "command": "$compact_hook_path"}]
      }
    ],
    "PreToolUse": [{
      "matcher": "TodoWrite",
      "hooks": [{"type": "command", "command": "$capstone_hook_path"}]
    }]
  }
}
EOF

    # Tutorial marker — tells Claude Code this is a Multivac project,
    # includes version stamp for upgrade detection and topic for display
    cat > "$project_dir/CLAUDE.md" << EOF
<!-- multivac-tutorial -->
<!-- multivac-version: $MULTIVAC_VERSION -->
<!-- topic: $topic_display -->
## Tutorial Mode

This is a Multivac tutorial project. You are a programming tutor guiding the user through a structured curriculum.

**Topic:** $topic_display

**Quick reference:**
- Progress tracking: Use the \`learning-tracker\` MCP server tools
- Current position: Call \`get_current_position\` to find where the user left off
- Full instructions: Read \`~/.claude/prompts/session.md\`

**After compaction or context loss:** Read \`~/.claude/prompts/session.md\` and call \`get_current_position\`, then resume the lesson flow.
<!-- /multivac-tutorial -->
EOF
}

# Upgrade a project to the current version
upgrade_project() {
    local project_dir="$1"

    if ! is_multivac_project "$project_dir"; then
        echo "Error: Not a Multivac project: $project_dir"
        exit 1
    fi

    local topic_display
    topic_display=$(get_topic_name "$project_dir")
    local old_version
    old_version=$(get_project_version "$project_dir")

    if [[ -z "$topic_display" ]]; then
        echo "Error: Could not determine topic from CLAUDE.md"
        exit 1
    fi

    echo "Upgrading project: $topic_display"
    echo "  Version: ${old_version:-unknown} -> $MULTIVAC_VERSION"
    echo ""

    write_project_config "$project_dir" "$topic_display"
    echo "  Updated .mcp.json"
    echo "  Updated .claude/settings.json"
    echo "  Updated CLAUDE.md"

    echo ""
    echo "Upgrade complete!"
}

# Offer to upgrade if project version doesn't match current version
offer_upgrade_if_needed() {
    local project_dir="$1"
    local project_version
    project_version=$(get_project_version "$project_dir")

    if [[ "$project_version" != "$MULTIVAC_VERSION" ]]; then
        echo ""
        echo "This project was created with Multivac ${project_version:-<unknown>} (current: $MULTIVAC_VERSION)"
        read -p "  Upgrade now? (Y/n) " -n 1 -r
        echo ""
        if [[ ! $REPLY =~ ^[Nn]$ ]]; then
            upgrade_project "$project_dir"
        fi
    fi
}

# Find next available topic number (sets TOPIC and PROJECT_DIR)
use_next_topic_number() {
    local base_topic="$1"
    local counter=2
    while [[ -d "$MULTIVAC_DIR/${base_topic}-${counter}" ]]; do
        ((counter++))
    done
    TOPIC="${base_topic}-${counter}"
    PROJECT_DIR="$MULTIVAC_DIR/$TOPIC"
    echo "Creating new tutorial: $TOPIC"
}

# Initialize existing directory as tutorial (with backup warning)
initialize_existing_directory() {
    EXISTING_FILES=""
    [[ -f "$PROJECT_DIR/.mcp.json" ]] && EXISTING_FILES="$EXISTING_FILES  - .mcp.json\n"
    [[ -f "$PROJECT_DIR/.claude/settings.json" ]] && EXISTING_FILES="$EXISTING_FILES  - .claude/settings.json\n"
    [[ -f "$PROJECT_DIR/CLAUDE.md" ]] && EXISTING_FILES="$EXISTING_FILES  - CLAUDE.md\n"

    if [[ -n "$EXISTING_FILES" ]]; then
        echo ""
        echo "The following files will be backed up to *.bak and replaced:"
        echo -e "$EXISTING_FILES"
        read -p "Continue? (y/N) " -n 1 -r
        echo ""
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Cancelled."
            exit 0
        fi

        # Create backups
        [[ -f "$PROJECT_DIR/.mcp.json" ]] && cp "$PROJECT_DIR/.mcp.json" "$PROJECT_DIR/.mcp.json.bak"
        [[ -f "$PROJECT_DIR/.claude/settings.json" ]] && cp "$PROJECT_DIR/.claude/settings.json" "$PROJECT_DIR/.claude/settings.json.bak"
        [[ -f "$PROJECT_DIR/CLAUDE.md" ]] && cp "$PROJECT_DIR/CLAUDE.md" "$PROJECT_DIR/CLAUDE.md.bak"
    fi

    echo "Initializing existing directory as tutorial..."
}

# ------------------------------------------------------------------------------
# Subcommands
# ------------------------------------------------------------------------------

if [[ "${1:-}" == "upgrade" ]]; then
    shift
    target="${1:-.}"
    target="$(cd "$target" 2>/dev/null && pwd)" || { echo "Error: Directory not found: ${1:-.}"; exit 1; }
    upgrade_project "$target"
    exit 0
fi

# ------------------------------------------------------------------------------
# Argument parsing
# ------------------------------------------------------------------------------

TOPIC=""
NEW_MODE=false
LAUNCH_MODE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --dir|-d)
            MULTIVAC_DIR="$2"
            shift 2
            ;;
        --new|-n)
            NEW_MODE=true
            shift
            ;;
        --launch|-l)
            LAUNCH_MODE=true
            shift
            ;;
        -h|--help)
            echo "Usage: multivac [topic] [--dir <path>] [--new] [--launch]"
            echo "       multivac upgrade [path]"
            echo ""
            echo "Create and start a Multivac tutorial project."
            echo ""
            echo "Arguments:"
            echo "  [topic]         Tutorial topic (default: tutorial)"
            echo "                  Examples: python, javascript, rust"
            echo "                  Multi-word topics are converted to lowercase with hyphens"
            echo "                  e.g., 'Data Science' becomes 'data-science'"
            echo ""
            echo "Subcommands:"
            echo "  upgrade [path]  Upgrade a project to the current Multivac version"
            echo "                  Rewrites config files while preserving progress"
            echo "                  (defaults to current directory if no path given)"
            echo ""
            echo "Options:"
            echo "  --dir, -d       Create tutorial in this directory instead of the default"
            echo "                  (one-time override, does not change the default)"
            echo "  --new, -n       Skip prompts and always create a new project"
            echo "                  (uses numbered suffix if directory exists)"
            echo "  --launch, -l    Launch Claude Code after setup"
            echo "                  (cannot be used from within Claude Code)"
            echo "  -h, --help      Show this help message"
            echo ""
            echo "The default directory can be set during installation or via MULTIVAC_HOME."
            echo ""
            echo "Examples:"
            echo "  multivac                           # creates ~/multivac/tutorial"
            echo "  multivac python                    # creates ~/multivac/python"
            echo "  multivac 'data science'            # creates ~/multivac/data-science"
            echo "  multivac python --new              # creates ~/multivac/python-2 if python exists"
            echo "  multivac python --launch           # creates project and opens Claude Code"
            echo "  multivac python --new --launch     # creates new project and opens Claude Code"
            echo "  multivac rust --dir ~/code         # creates ~/code/rust (one-time)"
            echo "  multivac upgrade                   # upgrades project in current directory"
            echo "  multivac upgrade ~/multivac/python # upgrades a specific project"
            exit 0
            ;;
        -*)
            echo "Unknown option: $1"
            echo "Run 'multivac --help' for usage"
            exit 1
            ;;
        *)
            if [[ -z "$TOPIC" ]]; then
                TOPIC="$1"
            else
                echo "Error: Multiple topics specified"
                echo "Run 'multivac --help' for usage"
                exit 1
            fi
            shift
            ;;
    esac
done

# ------------------------------------------------------------------------------
# Main logic
# ------------------------------------------------------------------------------

# Default topic if not specified
TOPIC="${TOPIC:-tutorial}"

# Sanitize topic: lowercase, replace spaces and special chars with hyphens
TOPIC="$(echo "$TOPIC" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | sed 's/--*/-/g' | sed 's/^-//;s/-$//')"

# Check prerequisites
if ! command -v claude &> /dev/null; then
    echo "Error: Claude Code CLI not found"
    echo "Install it from: https://docs.anthropic.com/en/docs/claude-code"
    exit 1
fi

# Determine project directory
PROJECT_DIR="$MULTIVAC_DIR/$TOPIC"

# Find all multivac projects matching this topic (base + numbered variants)
BASE_TOPIC="$TOPIC"
MULTIVAC_PROJECTS=()
MULTIVAC_DIRS=()

for dir in "$MULTIVAC_DIR/$BASE_TOPIC" "$MULTIVAC_DIR/$BASE_TOPIC"-[0-9]*; do
    if [[ -d "$dir" ]] && is_multivac_project "$dir"; then
        MULTIVAC_PROJECTS+=("$(basename "$dir")")
        MULTIVAC_DIRS+=("$dir")
    fi
done

# Check if base directory exists (even if not a multivac project)
BASE_DIR="$MULTIVAC_DIR/$BASE_TOPIC"
BASE_EXISTS=false
[[ -d "$BASE_DIR" ]] && BASE_EXISTS=true

# Handle based on what we found
if [[ ${#MULTIVAC_PROJECTS[@]} -eq 0 ]]; then
    # No multivac projects found
    if $BASE_EXISTS; then
        if $NEW_MODE; then
            # --new mode: skip prompts, create numbered directory
            use_next_topic_number "$BASE_TOPIC"
        else
            # Interactive: ask what to do
            echo "Directory '$BASE_TOPIC' exists at $BASE_DIR but isn't a Multivac tutorial."
            echo ""
            echo "  [i]nitialize this directory as a tutorial"
            echo "  [n]ew tutorial in a separate directory (${BASE_TOPIC}-2, etc.)"
            echo "  [q]uit"
            echo ""
            read -p "Choice: " -n 1 -r
            echo ""

            case $REPLY in
                [Ii])
                    PROJECT_DIR="$BASE_DIR"
                    TOPIC="$BASE_TOPIC"
                    initialize_existing_directory
                    ;;
                [Nn])
                    use_next_topic_number "$BASE_TOPIC"
                    ;;
                *)
                    echo "Cancelled."
                    exit 0
                    ;;
            esac
        fi
    fi
    # If base doesn't exist, fall through to create new project

elif [[ ${#MULTIVAC_PROJECTS[@]} -eq 1 ]]; then
    # Exactly one multivac project found
    if $NEW_MODE; then
        # --new mode: skip prompts, create numbered directory
        use_next_topic_number "$BASE_TOPIC"
    else
        # Interactive: ask what to do
        PROJECT_DIR="${MULTIVAC_DIRS[0]}"
        TOPIC="${MULTIVAC_PROJECTS[0]}"
        TOPIC_NAME=$(get_topic_name "$PROJECT_DIR")

        echo "Found tutorial: $TOPIC ($TOPIC_NAME)"
        echo ""
        echo "  [c]ontinue this tutorial"
        echo "  [n]ew tutorial (creates ${BASE_TOPIC}-2, ${BASE_TOPIC}-3, etc.)"
        echo "  [q]uit"
        echo ""
        read -p "Choice: " -n 1 -r
        echo ""

        case $REPLY in
            [Cc])
                offer_upgrade_if_needed "$PROJECT_DIR"
                launch_or_instruct "$PROJECT_DIR" "continue"
                ;;
            [Nn])
                use_next_topic_number "$BASE_TOPIC"
                ;;
            *)
                echo "Cancelled."
                exit 0
                ;;
        esac
    fi

else
    # Multiple multivac projects found
    if $NEW_MODE; then
        # --new mode: skip prompts, create numbered directory
        use_next_topic_number "$BASE_TOPIC"
    else
        # Interactive: ask what to do
        echo "Found ${#MULTIVAC_PROJECTS[@]} tutorials:"
        echo ""
        for i in "${!MULTIVAC_PROJECTS[@]}"; do
            local_topic_name=$(get_topic_name "${MULTIVAC_DIRS[$i]}")
            echo "  [$((i+1))] ${MULTIVAC_PROJECTS[$i]} ($local_topic_name)"
        done
        echo ""
        echo "  [n]ew tutorial"
        echo "  [q]uit"
        echo ""
        read -p "Choice: " -r
        echo ""

        if [[ "$REPLY" =~ ^[0-9]+$ ]] && [[ "$REPLY" -ge 1 ]] && [[ "$REPLY" -le ${#MULTIVAC_PROJECTS[@]} ]]; then
            # User selected a number
            idx=$((REPLY - 1))
            PROJECT_DIR="${MULTIVAC_DIRS[$idx]}"
            TOPIC="${MULTIVAC_PROJECTS[$idx]}"
            offer_upgrade_if_needed "$PROJECT_DIR"
            launch_or_instruct "$PROJECT_DIR" "continue"
        elif [[ "$REPLY" =~ ^[Nn]$ ]]; then
            use_next_topic_number "$BASE_TOPIC"
        else
            echo "Cancelled."
            exit 0
        fi
    fi
fi

# Create project structure
echo "Creating tutorial project at $PROJECT_DIR..."
mkdir -p "$PROJECT_DIR/.multivac"

# Convert base topic to title case for display (e.g., "data-science" -> "Data Science")
# Use BASE_TOPIC so numbered suffixes like "python-2" still display as "Python"
TOPIC_DISPLAY="$(echo "$BASE_TOPIC" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2))}1')"

# Write .mcp.json (MCP server config), .claude/settings.json (hooks), and CLAUDE.md (tutorial marker)
write_project_config "$PROJECT_DIR" "$TOPIC_DISPLAY"

echo ""
echo "Tutorial project created!"
launch_or_instruct "$PROJECT_DIR" "start"
